<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#4361ee;--primary-light:#eef2ff;--secondary:#6c757d;--success:#28a745;
      --danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--white:#ffffff;--border:#e0e0e0;
      --shadow:0 4px 12px rgba(0,0,0,0.08);--radius:12px;--transition:all .3s ease
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Poppins,sans-serif;background:#f0f2f5;color:#333;line-height:1.6}
    .container{max-width:100%;margin:0 auto;padding:20px}
    .box{background:var(--white);padding:25px;border-radius:var(--radius);box-shadow:var(--shadow);
      border:1px solid var(--border);margin-bottom:20px}
    h3,h4{color:var(--dark);font-weight:600;margin-bottom:15px}
    input,button{width:100%;padding:14px 16px;margin:10px 0;border-radius:8px;border:1px solid var(--border);
      font-family:Poppins,sans-serif;font-size:.95rem}
    button{background:linear-gradient(145deg,var(--primary),#5473ff);color:#fff;border:none;font-weight:600;cursor:pointer}
    #loading,#notif,#error{padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-weight:500;display:none}
    #notif{background:rgba(40,167,69,.1);color:var(--success)} #error{background:rgba(220,53,69,.1);color:var(--danger)}
    .preview-container{margin-top:20px;padding:15px;background:var(--light);border-radius:var(--radius)}
    .video-preview{width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden;margin-bottom:10px}
    .video-preview iframe{width:100%;height:100%;border:none}
  </style>
</head>
<body>
<div class="container">
  <div id="authBox" class="box">
    <h3>Login / Daftar</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login / Daftar</button>
  </div>

  <div id="panel" class="box" style="display:none;">
    <h3>Buat / Update Link</h3>
    <small>Tempel link video <b>:contentReference[oaicite:1]{index=1}</b> / :contentReference[oaicite:2]{index=2}</b> — otomatis dikonversi jadi embed.</small>
    <input id="videoLink" type="url" placeholder="Link Video">
    <input id="targetLink" type="url" placeholder="Link Tujuan">
    <button onclick="saveLink()">Simpan</button>
    <div id="loading">⏳ Menyimpan...</div>
    <div id="notif">✅ Link berhasil disimpan</div>
    <div id="error"></div>
    <div class="preview-container"><div id="preview">Belum ada postingan</div></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
  authDomain: "fypt-1000.firebaseapp.com",
  projectId: "fypt-1000",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user=>{
  if(user){document.getElementById('authBox').style.display='none';
    document.getElementById('panel').style.display='block';}
});

async function login(){
  const email = email.value.trim(), pass = password.value.trim();
  try{
    await signInWithEmailAndPassword(auth,email,pass)
  }catch{
    await createUserWithEmailAndPassword(auth,email,pass)
  }
}

// fungsi resolve link pendek TikTok
async function resolveTikTok(url){
  if(!url.includes('tiktok')) return url;
  try{
    const res = await fetch(url,{redirect:'follow'});
    return res.url;
  }catch(e){
    console.error(e);
    return url;
  }
}

async function saveLink(){
  const rawVideo = document.getElementById('videoLink').value.trim();
  const target = document.getElementById('targetLink').value.trim();
  if(!rawVideo || !target) return alert('Isi semua field');

  document.getElementById('loading').style.display='block';
  const video = await resolveTikTok(rawVideo); // resolve tiktok short link

  try{
    const q = query(collection(db,'posts'),where('video','==',video));
    const snap = await getDocs(q);
    if(!snap.empty){
      await updateDoc(doc(db,'posts',snap.docs[0].id),{target});
    }else{
      await addDoc(collection(db,'posts'),{video,target});
    }
    document.getElementById('notif').style.display='block';
    const embed = video.includes('youtube')
      ? `<iframe src="https://www.youtube.com/embed/${new URL(video).searchParams.get('v')}" allowfullscreen></iframe>`
      : `<iframe src="${video.replace('www','www').replace('tiktok.com','www.tiktok.com/embed')}" allowfullscreen></iframe>`;
    document.getElementById('preview').innerHTML = 
      `<div class="video-preview">${embed}</div><a href="${target}" target="_blank">${target}</a>`;
  }catch(e){
    document.getElementById('error').textContent=e.message;
    document.getElementById('error').style.display='block';
  }finally{
    document.getElementById('loading').style.display='none';
  }
}
</script>
</body>
</html>
