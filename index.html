<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {--primary:#4361ee;--primary-light:#eef2ff;--secondary:#6c757d;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--white:#fff;--border:#e0e0e0;--shadow:0 4px 12px rgba(0,0,0,.08);--radius:12px;--transition:all .3s ease;--redirect-color:#4361ee;--redirect-light:#eef2ff;--popup-color:#ff5722;--popup-light:#fff2ee;--banner-color:#25d366;--banner-light:#f0fff4}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:#f0f2f5;color:#333;line-height:1.4}
    .container{max-width:100%;margin:0 auto;padding:10px}
    .box{background:var(--white);padding:10px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:8px;border:1px solid var(--border)}
    h3,h4{color:var(--dark);font-weight:600;margin-bottom:8px}
    h3{font-size:1.2rem}
    input,button,textarea{width:100%;padding:8px 10px;margin:8px 0;border-radius:8px;border:1px solid var(--border);font-size:.95rem}
    input:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.15)}
    button{background:linear-gradient(145deg,var(--primary),#5473ff);color:var(--white);border:none;font-weight:600;cursor:pointer;padding:12px}
    .preview-container{margin-top:20px;padding:15px;background:var(--light);border-radius:var(--radius)}
    .video-preview{width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden}
    .video-preview iframe{width:100%;height:100%;border:none}
    #loadingPopup{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:9999;align-items:center;justify-content:center}
    #loadingPopup .content{background:#fff;padding:20px 30px;border-radius:var(--radius);box-shadow:var(--shadow);font-weight:600}
  </style>
</head>
<body>
<div class="container">
  <div id="authBox" class="box">
    <h3>Login / Daftar</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login / Daftar</button>
  </div>

  <div id="panel" class="box" style="display:none;">
    <h3>Buat / Update Link</h3>
    <input id="videoLink" type="url" placeholder="Link Video TikTok / YouTube">
    <input id="targetLink" type="url" placeholder="Link Tujuan">
    <button onclick="saveLink()">Simpan</button>
    <h4>Preview</h4>
    <div class="preview-container"><div id="preview">Belum ada postingan</div></div>
    <button onclick="logout()" style="margin-top:10px;background:var(--danger)">Logout</button>
  </div>
</div>

<div id="loadingPopup"><div class="content">‚è≥ Sedang memproses...</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",authDomain:"fypt-1000.firebaseapp.com",projectId:"fypt-1000",storageBucket:"fypt-1000.appspot.com",messagingSenderId:"1002775921451",appId:"1:1002775921451:web:d00ff8bd6964a8fcad7b6e",measurementId:"G-QYGXBF7NWR"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const preview=document.getElementById('preview');
const loadingPopup=document.getElementById('loadingPopup');

async function resolveTikTokShortLink(url){try{const res=await fetch(url,{method:"HEAD",redirect:"follow"});return res.url||url}catch{return url}}

async function fetchOEmbed(url){try{let endpoint=null;if(url.includes("tiktok.com"))endpoint=`https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`;else if(url.includes("youtube.com")||url.includes("youtu.be"))endpoint=`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;if(!endpoint)return null;const res=await fetch(endpoint);if(!res.ok)throw new Error();const data=await res.json();return data.html}catch{return null}}

function convertToEmbed(url){if(url.includes("youtube.com/watch?v=")){const id=new URL(url).searchParams.get("v");return `https://www.youtube.com/embed/${id}`}if(url.includes("youtu.be/")){const id=url.split("youtu.be/")[1].split(/[?&]/)[0];return `https://www.youtube.com/embed/${id}`}if(url.includes("tiktok.com")){const match=url.match(/video\/(\d+)/);if(match)return `https://www.tiktok.com/embed/v2/${match[1]}`}return url}

async function showPreview(url){let embedHtml=await fetchOEmbed(url);if(!embedHtml){const embedUrl=convertToEmbed(url);embedHtml=`<iframe src="${embedUrl}" allowfullscreen></iframe>`}preview.innerHTML=`<div class="video-preview">${embedHtml}</div>`}

window.login=async()=>{const email=document.getElementById('email').value.trim();const password=document.getElementById('password').value.trim();try{await signInWithEmailAndPassword(auth,email,password)}catch{await createUserWithEmailAndPassword(auth,email,password)}};

onAuthStateChanged(auth,(user)=>{if(user){document.getElementById('authBox').style.display='none';document.getElementById('panel').style.display='block'}else{document.getElementById('authBox').style.display='block';document.getElementById('panel').style.display='none'}});

window.saveLink=async()=>{
  const rawUrl=document.getElementById('videoLink').value.trim();
  const targetUrl=document.getElementById('targetLink').value.trim();
  if(!rawUrl||!targetUrl)return;
  loadingPopup.style.display='flex';
  try{
    const resolved=await resolveTikTokShortLink(rawUrl);
    await showPreview(resolved);
    await addDoc(collection(db,"links"),{owner:auth.currentUser.uid,video:resolved,target:targetUrl,createdAt:Date.now()});
  }catch(e){alert("Gagal simpan: "+e.message)}
  loadingPopup.style.display='none';
};

window.logout=async()=>{await signOut(auth)};
</script>
</body>
</html>
