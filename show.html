<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saksikan Video Ini!</title>

  <!-- OG default (akan dioverride client-side, crawler hanya lihat ini) -->
  <meta property="og:title" content="Saksikan Video Ini!">
  <meta property="og:description" content="Tonton video singkat ini — ada info penting di akhir.">
  <meta property="og:image" content="https://example.com/default-thumb.jpg">
  <meta property="og:url" content="https://yourdomain.com/show.html">
  <meta property="og:type" content="video.other">

  <style>
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#000;color:#fff}
    .center{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .video-wrap{position:relative;width:100%;height:100%;overflow:hidden;background:#000}
    .video-iframe{width:100%;height:100%;border:0}
    .overlay{position:absolute;left:50%;transform:translateX(-50%);bottom:16px;background:rgba(0,0,0,.55);padding:10px 14px;border-radius:10px;text-align:center}
    .banner{position:fixed;left:0;right:0;bottom:-100px;background:linear-gradient(90deg,#4361ee,#3a0ca3);padding:10px 14px;display:flex;align-items:center;justify-content:center;gap:10px;transition:.35s;transform:translateY(100%)}
    .banner.visible{transform:translateY(0)}
    .banner a{background:#ff5722;color:#fff;padding:8px 12px;border-radius:14px;text-decoration:none;font-weight:700}
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);opacity:0;pointer-events:none;transition:.25s}
    .modal-overlay.visible{opacity:1;pointer-events:auto}
    .modal{background:#fff;color:#111;padding:18px;border-radius:12px;max-width:360px;width:90%;text-align:center}
    .btn{display:inline-block;padding:8px 14px;border-radius:14px;background:#ff5722;color:#fff;text-decoration:none;font-weight:700}
    .loader{width:44px;height:44px;border:4px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
  </style>

  <!-- TikTok embed script -->
  <script async src="https://www.tiktok.com/embed.js"></script>
</head>
<body>
  <div id="loading" class="center">
    <div><div class="loader"></div><div style="margin-top:14px;color:#ddd">Memuat video...</div></div>
  </div>

  <div id="videoWrap" class="video-wrap hidden"></div>
  <div id="overlay" class="overlay hidden"><p>Tonton sampai habis, ada pesan penting!</p></div>

  <div id="banner" class="banner" aria-hidden="true">
    <div id="bannerText" style="flex:1;text-align:center;font-weight:600">Tonton sampai habis!</div>
    <a id="bannerBtn" href="#" class="btn" target="_blank">Klik Di Sini!</a>
    <button id="closeBanner" style="background:none;border:0;color:#fff;font-size:20px;cursor:pointer">×</button>
  </div>

  <div id="popupModal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <h3 id="popupTitle" style="margin-bottom:8px;color:#25d366">Transaksi Anti-Drama! 🎉</h3>
      <p id="popupText" style="margin-bottom:12px;color:#222">Sudah lihat kan? Kami punya solusinya.</p>
      <a id="popupBtn" class="btn" href="#" target="_blank">Lanjut ke Halaman Aman!</a>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI refs
    const loading = document.getElementById("loading");
    const videoWrap = document.getElementById("videoWrap");
    const overlay = document.getElementById("overlay");
    const banner = document.getElementById("banner");
    const bannerText = document.getElementById("bannerText");
    const bannerBtn = document.getElementById("bannerBtn");
    const closeBanner = document.getElementById("closeBanner");
    const popupModal = document.getElementById("popupModal");
    const popupTitle = document.getElementById("popupTitle");
    const popupText = document.getElementById("popupText");
    const popupBtn = document.getElementById("popupBtn");

    // helpers
    const setMeta = (p, c) => {
      let m=document.querySelector(`meta[property="${p}"]`);
      if(!m){m=document.createElement("meta");m.setAttribute("property",p);document.head.appendChild(m);}
      m.setAttribute("content",c);
    };

    const renderTikTok = (url, vid) => {
      videoWrap.innerHTML = `<blockquote class="tiktok-embed" cite="${url}" data-video-id="${vid}" style="max-width:605px;min-width:325px"><section></section></blockquote>`;
      const s=document.createElement("script");s.src="https://www.tiktok.com/embed.js";document.body.appendChild(s);
    };

    const renderYouTube = (vid) => {
      videoWrap.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${vid}?autoplay=1&rel=0&modestbranding=1&playsinline=1" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
    };

    const renderFallback = (url) => {
      videoWrap.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;padding:20px;color:#fff;text-align:center"><p>Pemutar tidak tersedia<br><a href="${url}" target="_blank" style="color:#25d366;text-decoration:underline">${url}</a></p></div>`;
    };

    const startCountdown = (seconds, cb) => {
      let n=seconds;
      const span=document.createElement("span");
      span.style.marginLeft="8px";span.textContent=`(${n})`;
      bannerText.appendChild(span);
      const iv=setInterval(()=>{
        n--;span.textContent=`(${n})`;
        if(n<=0){clearInterval(iv);cb();}
      },1000);
    };

    (async ()=>{
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      if(!id){loading.innerHTML="❌ ID tidak ditemukan";return;}

      const ref = doc(db,"links",id);
      const snap = await getDoc(ref);
      if(!snap.exists()){loading.innerHTML="❌ Data tidak ditemukan";return;}
      const d = snap.data();

      // OG dinamis (client-side, crawler tetap lihat default)
      setMeta("og:url", location.href);
      if(d.ogTitle) setMeta("og:title", d.ogTitle);
      if(d.ogDescription) setMeta("og:description", d.ogDescription);
      if(d.ogImage) setMeta("og:image", d.ogImage);
      document.title = d.ogTitle || "Saksikan Video Ini!";

      // tampilkan UI
      loading.classList.add("hidden");
      videoWrap.classList.remove("hidden");
      overlay.classList.remove("hidden");

      // render video
      if(d.videoLink.includes("tiktok.com")){
        const vid = (d.videoLink.match(/\/video\/(\d+)/)||[])[1] || "";
        renderTikTok(d.videoLink, vid);
      } else if(d.videoLink.includes("youtube.com") || d.videoLink.includes("youtu.be")){
        const m = d.videoLink.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_\-]{6,})/);
        if(m && m[1]) renderYouTube(m[1]); else renderFallback(d.videoLink);
      } else {
        renderFallback(d.videoLink);
      }

      // banner & popup
      bannerText.textContent = d.settings?.bannerText || "Tonton sampai habis!";
      bannerBtn.href = d.targetLink || "#";
      bannerBtn.textContent = d.settings?.bannerButtonText || "Klik Di Sini!";
      setTimeout(()=>banner.classList.add("visible"),1200);
      closeBanner.onclick = ()=>banner.classList.remove("visible");

      popupTitle.textContent = d.settings?.popupTitle || "Transaksi Anti-Drama!";
      popupText.textContent = d.settings?.popupText || "Sudah lihat kan? Kami punya solusinya.";
      popupBtn.href = d.targetLink || "#";
      popupBtn.textContent = d.settings?.popupButtonText || "Lanjut ke Halaman Aman!";
      if(d.settings?.popupEnabled!==false){
        setTimeout(()=>{
          popupModal.classList.add("visible");
          setTimeout(()=>popupModal.classList.remove("visible"), (d.settings?.popupDuration||5)*1000);
        }, (d.settings?.popupTime||10)*1000);
      }

      // redirect
      if(d.settings?.redirectEnabled!==false){
        startCountdown(d.settings?.redirectTime||15, ()=>location.href=d.targetLink);
      }

      // load iklan (delayed)
      setTimeout(()=>{
        if(!window.__monetagLoaded){
          window.__monetagLoaded=true;
          const s=document.createElement("script");
          s.dataset.zone="9885185";
          s.src="https://groleegni.net/vignette.min.js";
          document.body.appendChild(s);
        }
      },2500);

    })();
  </script>
</body>
</html>
