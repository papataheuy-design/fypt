<!DOCTYPE html>
<html lang="id">
<head>
    <!-- New ad script provided by the user -->
    <script>(function(s){s.dataset.zone='9885185',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saksikan Video Ini!</title>
    
    <!-- Open Graph Meta Tags for Facebook Preview -->
    <meta property="og:title" content="Saksikan Video Ini!">
    <meta property="og:description" content="Tonton video ini sampai habis dan temukan pesan penting di baliknya!">
    <meta property="og:image" content="https://placehold.co/1200x630/5735ff/ffffff?text=Video+Menarik">
    <meta property="og:url" content=""> <!-- You can insert the final URL of your page here -->
    <meta property="og:type" content="video.other">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            position: relative;
        }

        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
            object-fit: cover;
        }

        .overlay-text {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10;
        }

        .overlay-text p {
            margin: 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        @media (orientation: landscape) {
            .video-container iframe {
                object-fit: contain;
            }
        }
        
        /* Loading and Error Styles */
        .loading-state, .error-state {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 50;
            background-color: #000;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state h2 {
            margin-bottom: 15px;
        }

        /* Modal/Popup Styles */
        .modal-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
            padding: 10px;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px; /* Smaller padding */
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px; /* Smaller width */
            transform: translateY(100%);
            transition: transform 0.4s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            color: #25d366;
            font-size: 1em; /* Smaller font size */
            margin-bottom: 5px;
        }
        .modal-text {
            color: #555;
            font-size: 0.8em; /* Smaller font size */
            line-height: 1.4;
        }
        .modal-btn {
            background-color: #ff5722;
            color: white;
            padding: 6px 15px; /* Smaller padding */
            border: none;
            border-radius: 18px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 8px;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.85em; /* Smaller font size */
        }
        .modal-btn:hover {
            background-color: #e64a19;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <div id="loading-state" class="loading-state">
        <div class="loader"></div>
        <p style="margin-top: 20px;">Memuat video...</p>
    </div>

    <div id="video-container" class="video-container" style="display: none;">
        <!-- iframe will be inserted here by JavaScript -->
    </div>

    <div id="overlay-text" class="overlay-text" style="display: none;">
        <p>Tonton sampai habis, ada pesan penting di baliknya!</p>
    </div>
    
    <div id="popupModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Transaksi Anti-Drama! üéâ</h2>
            <p class="modal-text">Sudah lihat kan? Jangan sampai kejadian itu menimpa Anda! Kami punya solusinya.</p>
            <a href="#" id="modal-btn" class="modal-btn">Lanjut ke Halaman Aman!</a>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where }
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    
    const loadingState = document.getElementById('loading-state');
    const videoContainer = document.getElementById('video-container');
    const overlayText = document.getElementById('overlay-text');
    const popupModal = document.getElementById('popupModal');
    const modalBtn = document.getElementById('modal-btn');

    let redirectTimer;
    let popupTimer;

    // Fungsi untuk menampilkan error
    function showError(message) {
        loadingState.style.display = 'none';
        videoContainer.style.display = 'none';
        overlayText.style.display = 'none';
        const errorState = document.createElement('div');
        errorState.className = 'error-state';
        errorState.innerHTML = `<h2>‚ùå Terjadi Kesalahan</h2><p>${message}</p>`;
        document.body.appendChild(errorState);
    }

    // Fungsi untuk mengonversi link pendek TikTok menjadi link panjang
    async function resolveTikTokShortLink(shortUrl) {
      try {
        // Cek apakah ini link pendek TikTok (vm.tiktok.com, vt.tiktok.com)
        if (shortUrl.includes('vm.tiktok.com') || shortUrl.includes('vt.tiktok.com')) {
          // Lakukan request untuk mendapatkan URL akhir setelah redirect
          const response = await fetch(shortUrl, { 
            method: 'HEAD', 
            redirect: 'follow',
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
          });
          
          // Dapatkan URL akhir setelah semua redirect
          const finalUrl = response.url;
          
          // Jika URL akhir adalah link TikTok yang valid, kembalikan
          if (finalUrl.includes('tiktok.com') && finalUrl.includes('/video/')) {
            return finalUrl;
          }
        }
        
        // Jika bukan link pendek atau konversi gagal, kembalikan URL asli
        return shortUrl;
      } catch (error) {
        console.error('Error resolving TikTok short link:', error);
        return shortUrl; // Kembalikan URL asli jika terjadi error
      }
    }

    // Fungsi untuk mengonversi ke embed URL
    async function convertToEmbed(url) {
      try {
        // Jika link TikTok pendek, konversi ke link panjang terlebih dahulu
        let processedUrl = url;
        if (url.includes('vm.tiktok.com') || url.includes('vt.tiktok.com')) {
          processedUrl = await resolveTikTokShortLink(url);
        }

        if (processedUrl.includes("youtube.com/") || processedUrl.includes("youtu.be/")) {
          let videoId = "";
          if (processedUrl.includes("youtube.com/watch?v=")) {
            videoId = processedUrl.split("v=")[1].split("&")[0];
          } else if (processedUrl.includes("youtu.be/")) {
            videoId = processedUrl.split("youtu.be/")[1].split("?")[0];
          } else if (processedUrl.includes("youtube.com/embed/")) {
            videoId = processedUrl.split("embed/")[1].split("?")[0];
          } else if (processedUrl.includes("youtube.com/v/")) {
            videoId = processedUrl.split("v/")[1].split("?")[0];
          } else if (processedUrl.includes("youtube.com/shorts/")) {
            let videoId = processedUrl.split("shorts/")[1].split("?")[0];
            if (videoId) return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&rel=0&showinfo=0&playsinline=1`;
          }
          if (videoId) {
            return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&rel=0&showinfo=0&playsinline=1`;
          }
        } else if (processedUrl.includes("tiktok.com/")) {
          let videoId = "";
          if (processedUrl.includes("/video/")) {
            videoId = processedUrl.split("/video/")[1].split("?")[0];
          }
          if (videoId) {
            return `https://www.tiktok.com/embed/v2/${videoId}?autoplay=1`;
          }
        }
        return processedUrl;
      } catch (error) {
        console.error("Error converting URL:", error);
        return url;
      }
    }

    // Fungsi utama
    async function initializePage() {
      try {
        if (!id) {
          showError("ID tidak ditemukan.");
          return;
        }

        const q = query(collection(db, "links"), where("authLink", "==", id));
        const snap = await getDocs(q);

        if (snap.empty) {
          showError("Link tidak ditemukan.");
          return;
        }

        const data = snap.docs[0].data();
        const embedUrl = await convertToEmbed(data.videoLink);
        const redirectLink = data.targetLink;
        const videoDuration = 15; // Menggunakan durasi 15 detik

        // Sembunyikan loading dan tampilkan video
        loadingState.style.display = 'none';
        videoContainer.style.display = 'block';
        overlayText.style.display = 'block';
        videoContainer.innerHTML = `<iframe src="${embedUrl}" allow="autoplay; fullscreen; accelerometer; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        modalBtn.href = redirectLink;

        // Tampilkan pop-up setelah 12 detik (15 - 3)
        popupTimer = setTimeout(() => {
            popupModal.classList.add('visible');
        }, (videoDuration - 3) * 1000);

        // Alihkan halaman setelah 15 detik
        redirectTimer = setTimeout(() => {
            window.location.href = redirectLink;
        }, videoDuration * 1000);

      } catch (error) {
        console.error("Error:", error);
        showError("Terjadi kesalahan saat memuat video.");
      }
    }

    // Jalankan fungsi utama ketika halaman dimuat
    document.addEventListener('DOMContentLoaded', initializePage);
    
    window.addEventListener('beforeunload', function() {
      if (popupTimer) clearTimeout(popupTimer);
      if (redirectTimer) clearTimeout(redirectTimer);
    });
</script>

</body>
</html>
