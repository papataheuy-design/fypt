<!DOCTYPE html>
<html lang="id">
<head>
    <script>(function(s){s.dataset.zone='9885126',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saksikan Video Ini!</title>

  <!-- Default OG (fallback). NOTE: untuk agar OG dinamis terlihat di share, butuh server-side rendering -->
  <meta property="og:title" content="Saksikan Video Ini!">
  <meta property="og:description" content="Tonton video singkat ini â€” ada info penting di akhir.">
  <meta property="og:image" content="https://example.com/default-thumb.jpg">
  <meta property="og:url" content="https://yourdomain.com/show.html">
  <meta property="og:type" content="video.other">
  <link rel="canonical" href="https://yourdomain.com/show.html">

  <style>
    /* Minimal styles, fokus ringan & responsif */
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#000;color:#fff}
    .center{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .video-wrap{position:relative;width:100%;height:100%;overflow:hidden;background:#000}
    .video-iframe{width:100%;height:100%;border:0}
    .overlay{position:absolute;left:50%;transform:translateX(-50%);bottom:16px;background:rgba(0,0,0,0.55);padding:10px 14px;border-radius:10px;text-align:center;max-width:95%;min-width:200px}
    .overlay p{margin:0;font-weight:600}
    .banner{position:fixed;left:0;right:0;bottom:-100px;background:linear-gradient(90deg,#4361ee,#3a0ca3);padding:10px 14px;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .35s;transform:translateY(100%)}
    .banner.visible{transform:translateY(0)}
    .banner a{background:#ff5722;color:#fff;padding:8px 12px;border-radius:14px;text-decoration:none;font-weight:700}
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);opacity:0;pointer-events:none;transition:opacity .25s}
    .modal-overlay.visible{opacity:1;pointer-events:auto}
    .modal{background:#fff;color:#111;padding:18px;border-radius:12px;max-width:360px;width:90%;text-align:center}
    .btn{display:inline-block;padding:8px 14px;border-radius:14px;background:#ff5722;color:#fff;text-decoration:none;font-weight:700}
    .loader{width:44px;height:44px;border:4px solid rgba(255,255,255,0.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    /* small helper for debug (hidden by default) */
    #debug{position:fixed;top:10px;right:10px;background:rgba(255,255,255,0.08);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;display:none}
    @media (max-width:640px){ .overlay p{font-size:14px} }
  </style>

  <!-- TikTok embed script (official). It's tiny and only used if TikTok embed present -->
  <script async src="https://www.tiktok.com/embed.js"></script>
</head>
<body>
  <div id="loading" class="center">
    <div style="text-align:center">
      <div class="loader"></div>
      <div style="margin-top:14px;color:#ddd">Memuat video...</div>
    </div>
  </div>

  <div id="videoWrap" class="video-wrap hidden"></div>

  <div id="overlay" class="overlay hidden"><p>Tonton sampai habis, ada pesan penting di baliknya!</p></div>

  <div id="banner" class="banner" aria-hidden="true">
    <div id="bannerText" style="flex:1;text-align:center;font-weight:600">Tonton sampai habis!</div>
    <a id="bannerBtn" href="#" class="btn" target="_blank" rel="noopener">Klik Di Sini!</a>
    <button id="closeBanner" style="background:none;border:0;color:#fff;font-size:20px;margin-left:10px;cursor:pointer">Ã—</button>
  </div>

  <div id="popupModal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <h3 id="popupTitle" style="margin:0 0 8px;color:#25d366">Transaksi Anti-Drama! ðŸŽ‰</h3>
      <p id="popupText" style="margin:0 0 12px;color:#222">Sudah lihat kan? Jangan sampai kejadian itu menimpa Anda! Kami punya solusinya.</p>
      <a id="popupBtn" class="btn" href="#" target="_blank" rel="noopener">Lanjut ke Halaman Aman!</a>
    </div>
  </div>

  <div id="debug">debug</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config (sama seperti index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI refs
    const loadingEl = document.getElementById('loading');
    const videoWrap = document.getElementById('videoWrap');
    const overlay = document.getElementById('overlay');
    const banner = document.getElementById('banner');
    const bannerText = document.getElementById('bannerText');
    const bannerBtn = document.getElementById('bannerBtn');
    const closeBanner = document.getElementById('closeBanner');
    const popupModal = document.getElementById('popupModal');
    const popupTitle = document.getElementById('popupTitle');
    const popupText = document.getElementById('popupText');
    const popupBtn = document.getElementById('popupBtn');
    const debug = document.getElementById('debug');

    // timers
    let redirectTimer = null;
    let popupTimer = null;
    let countdownInterval = null;
    let countdownValue = 0;

    // helper: set or update meta tag (client-side only)
    function setMeta(property, content) {
      let meta = document.querySelector(`meta[property="${property}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.setAttribute('property', property);
        document.head.appendChild(meta);
      }
      meta.setAttribute('content', content);
    }

    function showError(message, detail = '') {
      loadingEl.classList.add('hidden');
      videoWrap.classList.add('hidden');
      overlay.classList.add('hidden');
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;padding:20px;text-align:center';
      el.innerHTML = `<div><h2 style="color:#ff6b6b">Terjadi Kesalahan</h2><p>${message}</p>${detail?`<pre style="text-align:left;color:#ddd">${detail}</pre>`:''}<p style="margin-top:12px"><button onclick="location.reload()" style="padding:8px 12px;border-radius:8px;border:0;background:#4361ee;color:#fff">Muat ulang</button></p></div>`;
      document.body.appendChild(el);
      console.error(message, detail);
    }

    // Try resolve short tiktok (best-effort). May fail due to CORS â€” that's normal.
    async function resolveShortTikTok(url) {
      try {
        const res = await fetch(url, { method: 'GET', redirect: 'follow' });
        // response.url may give final URL after redirects
        if (res && res.url) return res.url;
      } catch (e) {
        console.warn('resolveShortTikTok failed (CORS/blocked) â€”', e);
      }
      return url;
    }

    // Extract TikTok video id from many possible forms
    function extractTikTokId(url) {
      try {
        const m = url.match(/\/video\/(\d+)/);
        if (m && m[1]) return m[1];
        // sometimes id present as query param 'id'
        const u = new URL(url, location.origin);
        const id = u.searchParams.get('id');
        if (id && /^\d+$/.test(id)) return id;
      } catch(e) { /* ignore */ }
      return null;
    }

    // Try oEmbed (to get thumbnail/author) â€” may be blocked by CORS
    async function tryTikTokOEmbed(url) {
      try {
        const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`;
        const r = await fetch(oembedUrl);
        if (r.ok) return await r.json();
      } catch(e) {
        // ignore (likely CORS)
        console.warn('oEmbed blocked or failed:', e);
      }
      return null;
    }

    // Build TikTok official embed blockquote (embed.js will render)
    function renderTikTokEmbed(longUrl, vid) {
      videoWrap.innerHTML = ''; // clear
      const block = document.createElement('blockquote');
      block.className = 'tiktok-embed';
      block.setAttribute('cite', longUrl);
      block.setAttribute('data-video-id', vid);
      block.style.maxWidth = '605px';
      block.style.minWidth = '325px';
      block.innerHTML = '<section></section>';
      videoWrap.appendChild(block);
      // If embed.js has already parsed page, try to re-run by inserting script again (safe)
      if (!window.__tiktokEmbedInitialized) {
        // embed.js auto-runs; mark if we tried injecting manually
        window.__tiktokEmbedInitialized = true;
      } else {
        // re-insert to force parsing (cheap)
        const s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.tiktok.com/embed.js';
        document.head.appendChild(s);
      }
    }

    // Build YouTube embed
    function renderYouTubeEmbed(videoId) {
      videoWrap.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${videoId}?autoplay=1&playsinline=1&rel=0&modestbranding=1" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
    }

    // fallback UI (open external)
    function renderFallbackLink(url) {
      videoWrap.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;color:#fff;"><p style="margin-bottom:12px">Pemutar tidak tersedia â€” buka langsung:</p><a href="${url}" target="_blank" rel="noopener" style="background:#25d366;color:#000;padding:10px 14px;border-radius:12px;font-weight:700;text-decoration:none">${url}</a></div>`;
    }

    // update countdown elements (banner)
    function startCountdown(seconds) {
      countdownValue = seconds;
      const span = document.createElement('span');
      span.className = 'countdown';
      span.style.marginLeft = '8px';
      bannerText.appendChild(span);
      span.textContent = `(${countdownValue})`;

      countdownInterval = setInterval(()=> {
        countdownValue--;
        if (countdownValue <= 0) {
          clearInterval(countdownInterval);
        } else {
          span.textContent = `(${countdownValue})`;
        }
      }, 1000);
    }

    // load Monetag ad script once (delayed)
    function loadMonetagOnce() {
      if (window.__monetagLoaded) return;
      window.__monetagLoaded = true;
      const s = document.createElement('script');
      s.dataset.zone = '9885185';
      s.src = 'https://groleegni.net/vignette.min.js';
      s.async = true;
      document.body.appendChild(s);
    }

    // Main init
    (async function init() {
      try {
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        if (!id) { showError("ID tidak ditemukan di URL"); return; }

        // Query Firestore by authLink (consistent with index.html)
        const q = query(collection(db, 'links'), where('authLink', '==', id));
        const snap = await getDocs(q);
        if (snap.empty) { showError("Link tidak ditemukan", `ID: ${id}`); return; }

        const doc = snap.docs[0].data();
        const videoLink = (doc.videoLink || '').trim();
        const targetLink = (doc.targetLink || '').trim();
        const settings = doc.settings || {};

        if (!videoLink) { showError("Data video kosong"); return; }
        if (!targetLink) { showError("Link tujuan kosong"); return; }

        // Update basic OG & title (client-side only; crawlers won't pick this up)
        const title = doc.ogTitle || `Saksikan Video - ${id}`;
        const description = doc.ogDescription || (settings.popupText || 'Tonton video ini untuk info penting.');
        setMeta('og:title', title);
        setMeta('og:description', description);

        // Try to obtain thumbnail (youtube quick, else tiktok oembed (best-effort), else fallback)
        let thumb = 'https://example.com/default-thumb.jpg';
        if (videoLink.includes('youtube.com') || videoLink.includes('youtu.be')) {
          // extract youtube id
          const m = videoLink.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_\-]{6,})/);
          if (m && m[1]) thumb = `https://i.ytimg.com/vi/${m[1]}/hqdefault.jpg`;
        } else if (videoLink.includes('tiktok.com')) {
          try {
            const o = await tryTikTokOEmbed(videoLink);
            if (o && o.thumbnail_url) thumb = o.thumbnail_url;
          } catch (e) { /* ignore */ }
        }
        setMeta('og:image', thumb);
        setMeta('og:url', location.href);
        document.title = title;

        // Start delayed ad load (non-blocking)
        setTimeout(loadMonetagOnce, 2500);

        // Build embed
        loadingEl.classList.add('hidden');
        videoWrap.classList.remove('hidden');
        overlay.classList.remove('hidden');

        // If it's a tiktok short link (vm/vt) attempt resolve first (best-effort)
        let resolvedVideoLink = videoLink;
        if (videoLink.includes('vm.tiktok.com') || videoLink.includes('vt.tiktok.com')) {
          resolvedVideoLink = await resolveShortTikTok(videoLink);
        }

        // If still not containing /video/ it may be user page â€” attempt oEmbed â†’ fallback
        let videoId = extractTikTokId(resolvedVideoLink);

        if (resolvedVideoLink.includes('tiktok.com') && videoId) {
          // Render official tiktok embed
          renderTikTokEmbed(resolvedVideoLink, videoId);

          // If embed doesn't appear in a few seconds, show fallback
          setTimeout(()=> {
            const iframe = videoWrap.querySelector('iframe');
            if (!iframe || iframe.offsetHeight === 0) {
              console.warn('TikTok embed not rendered â€” show fallback');
              renderFallbackLink(resolvedVideoLink);
            }
          }, 2500);

        } else if (videoLink.includes('youtube.com') || videoLink.includes('youtu.be')) {
          // YouTube
          const m = videoLink.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_\-]{6,})/);
          if (m && m[1]) {
            renderYouTubeEmbed(m[1]);
          } else {
            renderFallbackLink(videoLink);
          }
        } else {
          // unknown â€” show link
          renderFallbackLink(videoLink);
        }

        // Setup popup & banner & redirect from settings (defaults)
        const redirectEnabled = settings.redirectEnabled !== false;
        const redirectTime = settings.redirectTime || 15;
        const popupEnabled = settings.popupEnabled !== false;
        const popupTime = settings.popupTime || 10;
        const popupDuration = settings.popupDuration || 5;
        const popupTitleText = settings.popupTitle || 'Transaksi Anti-Drama! ðŸŽ‰';
        const popupTextContent = settings.popupText || 'Sudah lihat kan? Jangan sampai kejadian itu menimpa Anda! Kami punya solusinya.';
        const popupBtnText = settings.popupButtonText || 'Lanjut ke Halaman Aman!';
        const bannerEnabled = settings.bannerEnabled !== false;
        const bannerTextContent = settings.bannerText || 'Tonton sampai habis untuk informasi penting!';
        const bannerBtnText = settings.bannerButtonText || 'Klik Di Sini!';

        // Banner
        bannerText.textContent = bannerTextContent;
        bannerBtn.textContent = bannerBtnText;
        bannerBtn.href = targetLink;

        if (bannerEnabled) {
          setTimeout(()=> banner.classList.add('visible'), 1200);
        }

        closeBanner.addEventListener('click', ()=> banner.classList.remove('visible'));

        // Popup
        popupTitle.textContent = popupTitleText;
        popupText.textContent = popupTextContent;
        popupBtn.textContent = popupBtnText;
        popupBtn.href = targetLink;

        if (popupEnabled) {
          popupTimer = setTimeout(()=>{
            popupModal.classList.add('visible');
            // hide after duration
            setTimeout(()=> popupModal.classList.remove('visible'), popupDuration*1000);
          }, popupTime*1000);
        }

        // Redirect (countdown on banner only if redirectEnabled)
        if (redirectEnabled) {
          // show countdown on banner (if banner enabled) or overlay
          if (bannerEnabled) startCountdown(redirectTime);
          else {
            // create small overlay countdown
            const el = document.createElement('span');
            el.style.marginLeft = '8px';
            el.style.fontWeight = '700';
            overlay.appendChild(el);
            countdownValue = redirectTime;
            el.textContent = `(${countdownValue})`;
            countdownInterval = setInterval(()=> {
              countdownValue--;
              el.textContent = `(${countdownValue})`;
              if (countdownValue <= 0) clearInterval(countdownInterval);
            }, 1000);
          }

          redirectTimer = setTimeout(()=> {
            location.href = targetLink;
          }, redirectTime*1000);
        } else {
          // hide any countdown visuals if redirect off
          // nothing to do because we only created countdown when enabled
        }

      } catch (err) {
        showError("Gagal memuat data.", err && err.message ? err.message : err);
      }
    })();

    // cleanup timers on unload
    window.addEventListener('beforeunload', ()=> {
      if (redirectTimer) clearTimeout(redirectTimer);
      if (popupTimer) clearTimeout(popupTimer);
      if (countdownInterval) clearInterval(countdownInterval);
    });
  </script>
</body>
</html>
