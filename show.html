<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tampilan Video</title>
  <style>
    html,body{height:100%;margin:0;background:#000}
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    iframe{width:100%;height:100%;border:0;background:#000}
    #notif{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:8px;font-family:sans-serif;display:none;
    }
    #status {
      position:fixed;top:8px;left:8px;background:rgba(255,255,255,0.06);color:#eee;padding:8px 10px;border-radius:8px;font-family:sans-serif;font-size:13px;
      max-width:calc(100% - 40px);word-break:break-word;
    }
    #fallback {
      position:fixed;right:10px;top:10px;display:flex;gap:8px;z-index:20;
    }
    .btn {
      background: rgba(0,0,0,0.6);
      color: white; padding:8px 10px; border-radius:8px; text-decoration:none; font-family:sans-serif;
      border:1px solid rgba(255,255,255,0.08);
    }
  </style>
</head>
<body>
  <div id="wrap"><iframe id="videoFrame" allow="autoplay; fullscreen" allowfullscreen></iframe></div>
  <div id="notif">⏳ Mengalihkan...</div>
  <div id="status">Memuat...</div>
  <div id="fallback" style="display:none">
    <a id="openOriginal" class="btn" target="_blank" rel="noopener">Buka video</a>
    <a id="openTarget" class="btn" target="_blank" rel="noopener">Buka tujuan</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const cfg = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(cfg);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const authId = params.get('id');
    const statusEl = document.getElementById('status');
    const notif = document.getElementById('notif');
    const iframe = document.getElementById('videoFrame');
    const fallback = document.getElementById('fallback');
    const openOriginal = document.getElementById('openOriginal');
    const openTarget = document.getElementById('openTarget');

    function logStatus(txt){ statusEl.textContent = txt; console.log('[show.html] ', txt); }

    // Helper: ekstrak ID YouTube
    function ytId(url){
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')) return u.pathname.split('/').filter(Boolean).pop();
        if(u.pathname.startsWith('/shorts/')) return u.pathname.split('/').pop();
        return u.searchParams.get('v') || null;
      }catch(e){ return null; }
    }

    // Helper: ekstrak TikTok ID (heuristik)
    function tiktokId(url){
      try{
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        const idx = parts.indexOf('video');
        if(idx >= 0 && parts[idx+1]) return parts[idx+1];
        // kadang id di akhir path
        const last = parts.pop();
        return /\d{6,}/.test(last) ? last : null;
      }catch(e){ return null; }
    }

    // Helper: Instagram shortcode
    function instaShortcode(url){
      try{
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        if(parts[0] === 'reel' && parts[1]) return parts[1];
        if(parts[0] === 'p' && parts[1]) return parts[1]; // post
        return null;
      }catch(e){ return null; }
    }

    // Convert biasa -> embed (autoplay where possible)
    function convertToEmbed(raw){
      if(!raw) return null;
      raw = raw.trim();
      // YouTube
      const yid = ytId(raw);
      if(yid){
        return {embed:`https://www.youtube.com/embed/${yid}?autoplay=1&controls=0&modestbranding=1&rel=0&playsinline=1`, original:raw, platform:'youtube'};
      }
      // TikTok
      if(/tiktok\.com/.test(raw)){
        const tid = tiktokId(raw);
        if(tid){
          // common embed URL pattern
          return {embed:`https://www.tiktok.com/embed/v2/${tid}`, original:raw, platform:'tiktok'};
        } else {
          return {embed:raw, original:raw, platform:'tiktok'};
        }
      }
      // Instagram Reels / post
      if(/instagram\.com/.test(raw)){
        const sc = instaShortcode(raw);
        if(sc){
          // instagram embed: path/embed
          const u = raw.split('?')[0];
          return {embed:`${u}embed`, original:raw, platform:'instagram'};
        }
        return {embed:raw, original:raw, platform:'instagram'};
      }
      // Facebook reels/video
      if(/facebook\.com/.test(raw) || /fb\.watch/.test(raw)){
        // use plugin endpoint
        return {embed:`https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(raw)}&autoplay=true&show_text=false`, original:raw, platform:'facebook'};
      }
      // fallback
      return {embed:raw, original:raw, platform:'unknown'};
    }

    async function loadAndPlay(){
      if(!authId){ logStatus('ID tidak ditemukan di URL'); return; }

      if(localStorage.getItem('watched_'+authId)){
        logStatus('Sudah pernah ditonton → keluar.');
        // jika kamu ingin redirect langsung ke target, uncomment:
        // location.href = '/';
        // otherwise close:
        try{ window.close(); }catch(e){}
        return;
      }

      logStatus('Mencari data di Firestore...');
      try{
        const q = query(collection(db,'links'), where('authLink','==', authId));
        const snap = await getDocs(q);
        if(snap.empty){
          logStatus('Link tidak ditemukan (authLink tidak ada).');
          return;
        }

        const doc = snap.docs[0];
        const data = doc.data();
        console.log('Firestore data:', data);
        const conv = convertToEmbed(data.videoLink);
        logStatus(`Platform terdeteksi: ${conv.platform} — memuat embed...`);

        // set buttons fallback
        openOriginal.href = conv.original || data.videoLink;
        openTarget.href = data.targetLink || '#';
        fallback.style.display = 'flex';

        // set iframe src
        iframe.src = conv.embed;

        // small heuristic: show fallback if iframe tetap blank after timeout
        let iframeLoaded = false;
        // try detect load using onload (may not fire for some cross-origin content but try)
        iframe.onload = () => { iframeLoaded = true; logStatus('Iframe load event fired.'); };

        // after 2s if no load event, still ok — many embeds won't fire onload reliably
        setTimeout(()=> {
          if(!iframeLoaded){
            logStatus('Jika tampilan kosong, platform mungkin memblokir embed. Gunakan tombol "Buka video".');
          }
        }, 2500);

        // after 10s: mark watched + show notif and redirect to target
        setTimeout(() => {
          localStorage.setItem('watched_'+authId,'1');
          notif.style.display = 'block';
          // hide iframe to avoid back-button replay
          iframe.style.display = 'none';
          setTimeout(()=> {
            location.href = data.targetLink;
          }, 1800);
        }, 10000);

      } catch(err){
        console.error(err);
        logStatus('Terjadi kesalahan saat memuat data: ' + (err.message || err));
      }
    }

    // jalankan
    loadAndPlay();
  </script>
</body>
</html>
