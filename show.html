<!DOCTYPE html>
<html lang="id">
<head>
  <script>(function(s){s.dataset.zone='9885185',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saksikan Video Ini!</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            position: relative;
        }

        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
            object-fit: cover;
        }

        .overlay-text {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10;
        }

        .overlay-text p {
            margin: 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        @media (orientation: landscape) {
            .video-container iframe {
                object-fit: contain;
            }
        }
        
        /* Loading and Error Styles */
        .loading-state, .error-state {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 50;
            background-color: #000;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state h2 {
            margin-bottom: 15px;
        }

        /* Modal/Popup Styles */
        .modal-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Posisikan di bagian bawah */
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px; /* Lebih kecil agar tidak terlalu besar di ponsel */
            border-radius: 12px 12px 0 0;
            text-align: center;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
            position: relative;
            transform: translateY(100%);
            transition: transform 0.4s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            color: #25d366;
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .modal-text {
            color: #555;
            font-size: 1em;
            line-height: 1.4;
        }
        .modal-btn {
            background-color: #ff5722;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 20px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .modal-btn:hover {
            background-color: #e64a19;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <div id="loading-state" class="loading-state">
        <div class="loader"></div>
        <p style="margin-top: 20px;">Memuat video...</p>
    </div>

    <div id="video-container" class="video-container" style="display: none;">
        <!-- iframe akan dimasukkan di sini oleh JavaScript -->
    </div>

    <div id="overlay-text" class="overlay-text" style="display: none;">
        <p>Tonton sampai habis, ada pesan penting di baliknya!</p>
    </div>
    
    <div id="popupModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">Transaksi Anti-Drama! üéâ</h2>
            <p class="modal-text">Sudah lihat kan? Jangan sampai kejadian itu menimpa Anda! Kami punya solusinya.</p>
            <a href="#" id="modal-btn" class="modal-btn">Lanjut ke Halaman Aman!</a>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where }
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    
    const loadingState = document.getElementById('loading-state');
    const videoContainer = document.getElementById('video-container');
    const overlayText = document.getElementById('overlay-text');
    const popupModal = document.getElementById('popupModal');
    const modalBtn = document.getElementById('modal-btn');

    let redirectTimer;
    let popupTimer;

    // Fungsi untuk menampilkan error
    function showError(message) {
        loadingState.style.display = 'none';
        videoContainer.style.display = 'none';
        overlayText.style.display = 'none';
        const errorState = document.createElement('div');
        errorState.className = 'error-state';
        errorState.innerHTML = `<h2>‚ùå Terjadi Kesalahan</h2><p>${message}</p>`;
        document.body.appendChild(errorState);
    }

    // Fungsi untuk mengonversi ke embed URL
    function convertToEmbed(url) {
      try {
        if (url.includes("youtube.com/") || url.includes("youtu.be/")) {
          let videoId = "";
          if (url.includes("youtube.com/watch?v=")) {
            videoId = url.split("v=")[1].split("&")[0];
          } else if (url.includes("youtu.be/")) {
            videoId = url.split("youtu.be/")[1].split("?")[0];
          } else if (url.includes("youtube.com/embed/")) {
            videoId = url.split("embed/")[1].split("?")[0];
          } else if (url.includes("youtube.com/v/")) {
            videoId = url.split("v/")[1].split("?")[0];
          }
          if (videoId) {
            return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&rel=0&showinfo=0&playsinline=1`;
          }
        } else if (url.includes("tiktok.com/")) {
          let videoId = "";
          if (url.includes("/video/")) {
            videoId = url.split("/video/")[1].split("?")[0];
          } else if (url.includes("vt.tiktok.com/")) {
            videoId = url.split("vt.tiktok.com/")[1].split("?")[0];
          }
          if (videoId) {
            return `https://www.tiktok.com/embed/v2/${videoId}?autoplay=1`;
          }
        }
        return url;
      } catch (error) {
        console.error("Error converting URL:", error);
        return url;
      }
    }

    // Fungsi utama
    async function initializePage() {
      try {
        if (!id) {
          showError("ID tidak ditemukan.");
          return;
        }

        const q = query(collection(db, "links"), where("authLink", "==", id));
        const snap = await getDocs(q);

        if (snap.empty) {
          showError("Link tidak ditemukan.");
          return;
        }

        const data = snap.docs[0].data();
        const embedUrl = convertToEmbed(data.videoLink);
        const redirectLink = data.targetLink;
        const videoDuration = 10; // Menggunakan durasi default 10 detik

        // Sembunyikan loading dan tampilkan video
        loadingState.style.display = 'none';
        videoContainer.style.display = 'block';
        overlayText.style.display = 'block';
        videoContainer.innerHTML = `<iframe src="${embedUrl}" allow="autoplay; fullscreen; accelerometer; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        modalBtn.href = redirectLink;

        // Tampilkan pop-up setelah 7 detik
        popupTimer = setTimeout(() => {
            popupModal.classList.add('visible');
        }, (videoDuration - 3) * 1000);

        // Alihkan halaman setelah 10 detik
        redirectTimer = setTimeout(() => {
            window.location.href = redirectLink;
        }, videoDuration * 1000);

      } catch (error) {
        console.error("Error:", error);
        showError("Terjadi kesalahan saat memuat video.");
      }
    }

    // Jalankan fungsi utama ketika halaman dimuat
    document.addEventListener('DOMContentLoaded', initializePage);
    
    window.addEventListener('beforeunload', function() {
      if (popupTimer) clearTimeout(popupTimer);
      if (redirectTimer) clearTimeout(redirectTimer);
    });
</script>

</body>
</html>
