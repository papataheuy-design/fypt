<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saksikan Video Ini!</title>

  <!-- OG fallback -->
  <meta property="og:title" content="Saksikan Video Ini!">
  <meta property="og:description" content="Tonton video singkat ini â€” ada info penting di akhir.">
  <meta property="og:image" content="https://example.com/default-thumb.jpg">
  <meta property="og:url" content="https://yourdomain.com/show.html">
  <meta property="og:type" content="video.other">
  <link rel="canonical" href="https://yourdomain.com/show.html">

  <style>
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#000;color:#fff}
    .center{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center}
    .video-wrap{position:relative;width:100%;height:100%;overflow:hidden;background:#000}
    .video-iframe{width:100%;height:100%;border:0}
    .hidden{display:none}
    .loader{width:44px;height:44px;border:4px solid rgba(255,255,255,0.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>

  <script async src="https://www.tiktok.com/embed.js"></script>
</head>
<body>
  <div id="loading" class="center">
    <div>
      <div class="loader"></div>
      <div style="margin-top:12px;color:#ddd">Memuat video...</div>
    </div>
  </div>

  <div id="videoWrap" class="video-wrap hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUgD15-9V1H2j3F4zFdMgg2q4bxP5bDyM",
      authDomain: "fypt-1000.firebaseapp.com",
      projectId: "fypt-1000",
      storageBucket: "fypt-1000.appspot.com",
      messagingSenderId: "1002775921451",
      appId: "1:1002775921451:web:d00ff8bd6964a8fcad7b6e",
      measurementId: "G-QYGXBF7NWR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loadingEl = document.getElementById("loading");
    const videoWrap = document.getElementById("videoWrap");

    function showMessage(msg){
      loadingEl.innerHTML = `<div style="color:#ff6b6b"><h3>${msg}</h3><p><a href="/index.html" style="color:#25d366">Kembali ke halaman utama</a></p></div>`;
    }

    function renderTikTokEmbed(url, vid){
      videoWrap.innerHTML = "";
      const block = document.createElement("blockquote");
      block.className = "tiktok-embed";
      block.setAttribute("cite", url);
      block.setAttribute("data-video-id", vid);
      block.innerHTML = "<section></section>";
      videoWrap.appendChild(block);
      const s = document.createElement("script");
      s.src = "https://www.tiktok.com/embed.js";
      s.async = true;
      document.body.appendChild(s);
    }

    function renderYouTubeEmbed(videoId){
      videoWrap.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${videoId}?autoplay=1&playsinline=1&rel=0&modestbranding=1" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    }

    function renderFallback(url){
      videoWrap.innerHTML = `<div class="center"><div><p>Video tidak bisa diputar, buka langsung:</p><a href="${url}" target="_blank" style="color:#25d366">${url}</a></div></div>`;
    }

    (async function init(){
      const params = new URLSearchParams(location.search);
      const id = params.get("id");

      if(!id){
        showMessage("ID tidak ditemukan di URL");
        return;
      }

      try{
        const q = query(collection(db,"links"), where("authLink","==",id));
        const snap = await getDocs(q);
        if(snap.empty){
          showMessage("Data tidak ditemukan");
          return;
        }

        const doc = snap.docs[0].data();
        const videoLink = (doc.videoLink || "").trim();
        loadingEl.classList.add("hidden");
        videoWrap.classList.remove("hidden");

        if(videoLink.includes("tiktok.com")){
          const m = videoLink.match(/\/video\/(\d+)/);
          if(m && m[1]){
            renderTikTokEmbed(videoLink, m[1]);
          }else{
            renderFallback(videoLink);
          }
        } else if(videoLink.includes("youtube.com") || videoLink.includes("youtu.be")){
          const m = videoLink.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([A-Za-z0-9_-]{6,})/);
          if(m && m[1]){
            renderYouTubeEmbed(m[1]);
          }else{
            renderFallback(videoLink);
          }
        } else {
          renderFallback(videoLink);
        }

      }catch(e){
        showMessage("Terjadi kesalahan saat mengambil data");
        console.error(e);
      }
    })();
  </script>
</body>
</html>
