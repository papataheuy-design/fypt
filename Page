<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tampilan Artikel Publik</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root{--primary:#4361ee;--primary-light:#eef2ff;--secondary:#6c757d;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--white:#ffffff;--border:#e0e0e0;--shadow:0 4px 12px rgba(0,0,0,0.08);--radius:12px;--transition:all 0.3s ease}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',sans-serif;background:#f0f2f5;padding:0;margin:0;line-height:1.4;color:#333;font-weight:400}
        .container{max-width:800px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:15px}
        .box{background:var(--white);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}
        h1,h2,h3{color:var(--dark);font-weight:600;margin-bottom:8px}
        h1{font-size:2rem;margin-bottom:10px}
        p{color:var(--secondary);line-height:1.6;font-size:1rem;margin-bottom:15px}
        img{max-width:100%;height:auto;border-radius:10px;margin:20px 0}
        button, a.btn{width:100%;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;text-align:center;text-decoration:none;display:block;margin-top:20px;font-size:1rem}
        button{background:linear-gradient(145deg,var(--primary),#5473ff);color:var(--white)}
        a.btn{background:var(--success);color:var(--white)}
        button:hover, a.btn:hover{opacity:0.9}
        .link-box{background:var(--primary-light);color:var(--primary);padding:10px;border-radius:8px;word-break:break-all;margin-top:10px;text-align:center;font-weight:500;box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);font-size:0.9rem}
        #notif{padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-weight:500;background-color:rgba(40,167,69,0.1);color:var(--success)}
        #error{padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-weight:500;background-color:rgba(220,53,69,0.1);color:var(--danger)}
        .info{color:var(--secondary);font-size:0.9rem;text-align:center;margin-top:20px}
        .go-back-link{margin-top:20px;text-align:center}
        .go-back-link a{color:var(--primary);text-decoration:none}
        .go-back-link a:hover{text-decoration:underline}
        @media (prefers-color-scheme:dark){body{background-color:#121212;color:#ffffff}.box{background-color:#1e1e1e;color:#ffffff;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid #ddd}h1,h2,h3{color:#ffffff}p{color:#ccc}button{background:linear-gradient(145deg,#3a4b99,#5a74ff)}a.btn{background:#38c172}.link-box{background-color:#2c2c2c;color:#eef2ff}}
        @media (prefers-color-scheme:dark){
          .box,
          .box h1,
          .box h2,
          .box h3,
          .box h4,
          .box label,
          .box p,
          .box span {
            color:#fff !important;
          }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="article-content" class="box" style="display:none;">
        <h1 id="article-title"></h1>
        <img id="article-image" src="" alt="Gambar Artikel">
        <p id="article-body"></p>
        <div id="banner-container"></div>
    </div>

    <div id="message-area" class="box" style="display:none;">
        <h3 id="message-title"></h3>
        <p id="message-text"></p>
    </div>

    <div class="go-back-link">
        <a href="panel_artikel.html">Kembali ke Panel Admin</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    setLogLevel('debug');
    const articleContent = document.getElementById('article-content');
    const articleTitle = document.getElementById('article-title');
    const articleImage = document.getElementById('article-image');
    const articleBody = document.getElementById('article-body');
    const bannerContainer = document.getElementById('banner-container');
    const messageArea = document.getElementById('message-area');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;

    function showMessage(title, text) {
        messageArea.style.display = 'block';
        messageTitle.textContent = title;
        messageText.textContent = text;
        articleContent.style.display = 'none';
    }

    async function getArticleData(docId, uid) {
        try {
            const articleDocRef = doc(collection(db, `/artifacts/${appId}/users/${uid}/articles`), docId);
            const articleSnap = await getDoc(articleDocRef);
            if (articleSnap.exists()) {
                return articleSnap.data();
            }
        } catch (e) {
            console.error("Error fetching article data:", e);
        }
        return null;
    }

    async function checkAndDisplayArticle() {
        if (!userId) {
            showMessage("Autentikasi Gagal", "Silakan muat ulang halaman atau periksa koneksi Anda.");
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        if (!docId) {
            showMessage("Artikel Tidak Ditemukan", "URL tidak valid. Silakan periksa kembali tautannya.");
            return;
        }

        const docData = await getArticleData(docId, userId);
        if (!docData) {
            showMessage("Artikel Tidak Ditemukan", "Postingan ini mungkin sudah kedaluwarsa atau tidak ada.");
            return;
        }
        
        // Tampilkan konten artikel
        articleTitle.textContent = docData.scrapedContent.title;
        articleImage.src = docData.scrapedContent.image;
        articleBody.textContent = docData.scrapedContent.body;
        articleContent.style.display = 'block';

        // Lakukan pengalihan dan pop-up saat halaman dimuat
        if (docData.redirectLink) {
            window.location.href = docData.redirectLink;
        }

        if (docData.popupLink) {
            // Note: Pop-up mungkin diblokir oleh browser.
            // Fitur ini paling baik digunakan dengan interaksi pengguna.
            window.open(docData.popupLink, '_blank');
        }

        // Tampilkan banner jika kode tersedia
        if (docData.bannerCode) {
            bannerContainer.innerHTML = docData.bannerCode;
        }
    }

    async function initFirebase() {
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            await new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        await signInAnonymously(auth);
                    }
                    unsubscribe();
                    resolve();
                });
            });

            if (initialAuthToken) {
                 await signInWithCustomToken(auth, initialAuthToken);
            }
            await checkAndDisplayArticle();
        }
    }

    window.onload = initFirebase;
</script>
</body>
</html>
